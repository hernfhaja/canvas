<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CardBoon</title>
    <script src="https://ajax.googleapis.com/ajax/libs/cesiumjs/1.78/Build/Cesium/Cesium.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.25.0/axios.js"
      integrity="sha512-II/TvxJGs27N3NEu/WWRFtyhBdSByZwS5ovX1vHXVsi2JXj0I5hRvHwgBPKbzZDk0wsKVDoEUEI8rAYGEF394A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
  </head>
  <body>
    <div class="p-5">
      <h1 class="text-3xl font-bold p-0 mt-3">ดาวน์โหลดเกียรติบัตรออนไลน์</h1>
      <button
        class="bg-orange-300 py-3 px-5 rounded-lg mt-5 shadow-xl text-lg font-bold"
        type="button"
        id="btnDownload"
      >
        ดาวน์โหลด
      </button>
      <canvas class="mt-5" id="myCanvas" width="1568" height="1044"></canvas>
    </div>

    <!-- <img
      id="imgConverted"
.      src="https://drive.google.com/uc?export=view&id=19wXFgEuIApWJ5A-8oyFU99C995TdbsM7"
      style="border: 2px solid #00f; margin-left: 10px; width: 400px"
    /> -->

    <script>
      function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return "";
        console.log(results);
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      //
      const lname = getParameterByName("lname");
      const pname = getParameterByName("pname");
      const fname = getParameterByName("fname");
      const grade = getParameterByName("lname");
      const phone = getParameterByName("phone");
      const phoneCellular = getParameterByName("phoneCellular");
      const address = getParameterByName("address");
      const zipcode = getParameterByName("zipcode");

      const today = new Date();
      const date =
        today.getFullYear() +
        "-" +
        (today.getMonth() + 1) +
        "-" +
        today.getDate();

      const time =
        today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();

      axios
        .post("https://sheetdb.io/api/v1/ru4bvltba47o3", {
          data: {
            เวลา: time,
            วันที่: date,
            คำนำหน้า: pname,
            ชื่อ: fname,
            นามสกุล: lname,
            ระดับชั้น: grade,
            เบอร์โทร: phone,
            เครื่อข่ายมือถือ: phoneCellular,
            ที่อยู่: address,
            ระหัสไปรษณีย์: zipcode,
          },
        })
        .then((response) => {
          console.log(response.data);
        });

      const btnDownload = document.querySelector("#btnDownload");
      const myCanvas = document.querySelector("#myCanvas");
      const ctx = myCanvas.getContext("2d");
      let imgObj = new Image();
      imgObj.src = "card.jpg";
      // imgObj.crossOrigin = "Anonymous";
      imgObj.onload = function () {
        ctx.drawImage(imgObj, 0, 0);
        ctx.fillText(pname + "   " + fname + "   " + lname, 500, 550);
      };

      // imgObj.src =
      //   "https://drive.google.com/uc?export=view&id=1SxmYDjJ1ha53VSWSm89rcVZUe6szDqxF";

      ctx.font = "60px Roboto";
      ctx.fillStyle = "black";

      // Click download
      btnDownload.addEventListener("click", function () {
        console.log("download");
        if (window.navigator.msSaveBlob) {
          window.navigator.msSaveBlob(myCanvas.msToBlob(), "canvas-image.png");
        } else {
          const a = document.createElement("a");

          document.body.appendChild(a);
          a.href = myCanvas.toDataURL(a);
          a.download = pname + fname + ".png";
          a.click();
        }
      });
    </script>
  </body>
</html>
